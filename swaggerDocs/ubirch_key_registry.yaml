# Documentation of the ubirch key registry
# created 02.08.2016, 13:45 from Beate Fiss
# last update: 02.08.2016, 18:55
swagger: '2.0'
info:
  version: "1.0.0"
  title: ubirch REST API
  description:
  
    This is the definition of the ubirch REST API containing the following parts:|
    
    - devices CRUD endpoints

    - key registry endpoints, where public keys of devices and apps can be stored and requested and handshakes between two parties can be performed
    
    - chain service endpoints, to get information about certificates, blockchain entries and bitcoin/etherium anchors to notarize that a message was sent 
    
basePath: '/api/v1'
produces: 
  - application/json
  
paths:

###############################################
#####             device CRUD            #####
###############################################

  /avatarService/device:
    post:
      tags:
        - avatar service
        - device CRUD
        - 2BImplemented
      summary: create a new device
      description: creates a new device with the given id; a name of the device is created in server, that can be changed with an update request
      parameters:
        - in: body
          name: device
          description: the device object with the new device data that should be created; MUST contain the new unique device id, that MUST nOT exist already
          required: true
          schema:
            $ref: '#/definitions/DeviceObject'
      responses:
        200:
          description: Successful response; returns data of the new created device
          schema:
            $ref: '#/definitions/DeviceObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

    get:
      tags:
        - avatar service
        - device CRUD
        - 2BImplemented
      summary: list of all devices as stubs
      description: returns an array of stubs of all devices the authenticated user has connected
      responses:
        200:
          description: Successful response; returns an array of device stubs
          schema:
            type: array
            items:
              $ref: '#/definitions/DeviceStubObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/avatarService/device/{deviceId}':
    put:
      tags:
        - avatar service
        - device CRUD
        - 2BImplemented
      summary: updates an existing device
      description: updates the device referenced by the given id with the sent data, if the authenticated user is autorized to do this
      parameters:
        - in: path
          name: deviceId
          description: unique id of the device that shall be updated
          required: true
          type: string
        - in: body
          name: device
          description: the device object with the new data to update the existing device data with
          required: true
          schema:
            $ref: '#/definitions/DeviceObject'
      responses:
        200:
          description: Successful response; returns the updated data of the device
          schema:
            $ref: '#/definitions/DeviceObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

    get:
      tags:
        - avatar service
        - device CRUD
        - 2BImplemented
      summary: read data of given device
      description: returns data of device with the given id, if the authenticated user is autorized to get it
      parameters:
        - in: path
          name: deviceId
          description: id of the requested device
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns data of requested device
          schema:
            $ref: '#/definitions/DeviceObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

    delete:
      tags:
        - avatar service
        - device CRUD
        - 2BImplemented
      summary: delete device
      description: deletes device with the given id, if the authenticated user is autorized to do
      parameters:
        - in: path
          name: deviceId
          description: id of the device, that shall be delete
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns data of the device before deleting it
          schema:
            $ref: '#/definitions/DeviceObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

        
  '/avatarService/device/stub/{deviceId}':
    get:
      tags:
        - avatar service
        - device CRUD
        - 2BImplemented
      summary: short data of given device
      description: returns a short data set of device with the given id, if the authenticated user is autorized to get it
      parameters:
        - in: path
          name: deviceId
          description: id of the requested device
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns short data set of requested device
          schema:
            $ref: '#/definitions/DeviceStubObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/avatarService/device/{deviceId}/history':
    get:
      tags:
        - avatar service
        - device history
        - 2BImplemented
      summary: list oflatest sent device states
      description: returns an array of the last 10 values the device sent in the format elastic search deliveres
      parameters:
        - in: path
          name: deviceId
          description: id of the requested device
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns an array of device states
          schema:
            type: array
            items:
              $ref: '#/definitions/DeviceStateObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/avatarService/device/{deviceId}/history/{from}/{size}':
    get:
      tags:
        - avatar service
        - device history
        - 2BImplemented
      summary: list of device states for pagination
      description: returns an array of values the device sent in the format elastic search deliveres; for pagination, deliveres the defined part of the whole list
      parameters:
        - in: path
          name: deviceId
          description: id of the requested device
          required: true
          type: string
        - in: path
          name: from
          description: the number of the jongest device state message we request; messages ordered by descending timestamps
          required: true
          type: string
        - in: path
          name: size
          description: number of device state message we request; starting from the message defined by 'from' to the past
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns an array of device states
          schema:
            type: array
            items:
              $ref: '#/definitions/DeviceStateObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'


###############################################
#####             chain service           #####
###############################################

  '/chainService/explorer/eventHash/{eventHash}':
    get:
      tags:
        - chainservice
      summary: short block Info for an event hash
      description: returns blockInfo of the block in which this event hash has been inserted
      parameters:
        - in: path
          name: eventHash
          description: event hash of the message for which the notorization state should be checked
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the short info of the block in which this message is part of
          schema:
            $ref: '#/definitions/BlockInfo'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/chainService/explorer/blockInfo/{blockHash}':
    get:
      tags:
        - chainservice
      summary: short block Info of the referenced block
      description: returns blockInfo of the block with the given block hash
      parameters:
        - in: path
          name: blockHash
          description: block hash of the requested block
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the short info of the requested block
          schema:
            $ref: '#/definitions/BlockInfo'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/chainService/explorer/nextBlockInfo/{blockHash}':
    get:
      tags:
        - chainservice
      summary: short block Info of the next block
      description: returns blockInfo of the next block
      parameters:
        - in: path
          name: blockHash
          description: block hash of the block previous of the requested block
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the short info of the requested block
          schema:
            $ref: '#/definitions/BlockInfo'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/chainService/explorer/fullBlock/{blockHash}':
    get:
      tags:
        - chainservice
      summary: full block data of the referenced block
      description: returns all data stored in the block with the given block hash
      parameters:
        - in: path
          name: blockHash
          description: block hash of the requested block
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns full block data of the requested block
          schema:
            $ref: '#/definitions/FullBlock'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'


###############################################
#####           public keys CRUD          #####
###############################################

  '/ubirch/keyregistry/pubkey':
    post:
      tags:
        - key registry
        - 2BImplemented
      summary: stores new public key
      description: stores the given public key with its unique pubKeyID
      parameters:
        - in: body
          name: pubkey
          description: the new public key object with the pubKey that should be stored for the unique pubKeyId - also part of the pub key object - in the key registry to be able to find the public key; pubKeyId may not exist already
          required: true
          schema:
            $ref: '#/definitions/PubKeyObject'
      responses:
        200:
          description: Successful response; returns the new created pubKeyObject
          schema:
            $ref: '#/definitions/PubKeyObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/ubirch/keyregistry/pubkey/{pubkeyid}':
    put:
      tags:
        - key registry
        - 2BImplemented
      summary: updates public key
      description: updates the given public key found by pubKeyID in the key registry with the given data; the public key must exist already
      parameters:
        - name: pubkeyid
          in: path
          description: unique id of the public key; pubKeyId must exist already in the keyRegistry
          required: true
          type: number
          format: integer
        - in: body
          name: pubkey
          description: the public key object with the new pubKey data that the existing pubKey should be updated with
          required: true
          schema:
            $ref: '#/definitions/PubKeyObject'
      responses:
        200:
          description: Successful response; returns the updated pubKeyObject
          schema:
            $ref: '#/definitions/PubKeyObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

    get:
      tags:
        - key registry
        - 2BImplemented
      summary: get public key
      description: returns the public key for the given pubKeyID from the key registry
      parameters:
        - name: pubkeyid
          in: path
          description: unique id of the public key to find it in the key registry
          required: true
          type: number
          format: integer
      responses:
        200:
          description: Successful response; returns the requested pubKeyObject
          schema:
            $ref: '#/definitions/PubKeyObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'

    delete:
      tags:
        - key registry
        - 2BImplemented
      summary: delete public key
      description: deletes the public key for the given pubKeyID from the key registry
      parameters:
        - name: pubkeyid
          in: path
          description: unique id of the public key to find it in the key registry
          required: true
          type: number
          format: integer
      responses:
        200:
          description: Successful response; returns the pubKeyObject that has been deleted from the keyRegistry
          schema:
            $ref: '#/definitions/PubKeyObject'
        '400':
          description: Not successful response
          schema:
            $ref: '#/definitions/ErrorResponse'
            
            
###############################################
#####           handshakes CRUD           #####
###############################################

  '/ubirch/keyregistry/handshake':
    post:
      tags:
        - handshake
        - 2BImplemented
      summary: new handshake
      description: initiates a new handshake
      parameters:
        - in: body
          name: handshake
          description: the necessary data to initiate a handshake that are the pubKeyIds of both handshake parties
          required: true
          schema:
            $ref: '#/definitions/HandshakeObject'
      responses:
        200:
          description: Successful response; returns the new created handshakeObject; the keyRegistry has added the following
          
          
            - pubKeys of both handshake parties

            - state = init
            
            - new unique handshake id
          schema:
            $ref: '#/definitions/HandshakeObject'
        '400':
          description: Not successful response; fails if
          
          
            - pubKeyId(s) of handshake party is missing
            
            - if no pubKey can be found for one or both pubKeyIds
            
            - dataset creation failed
            
            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/ubirch/keyregistry/handshake/{handshakeid}':
    get:
      tags:
        - handshake
        - 2BImplemented
      summary: returns handshake data
      description: returns the full handshake dataset of the handshake identified by the handshake id
      parameters:
        - in: path
          name: handshakeid
          description: id of the requested handshake
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the requested handshakeObject
          schema:
            $ref: '#/definitions/HandshakeObject'
        '400':
          description: Not successful response; fails if
          
          
            - handshakeid is missing
            
            - if no handshake can be found for the given handshakeid
            
            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'
    put:
      tags:
        - handshake
        - 2BImplemented
      summary: updates handshake data
      description: updates the handshake dataset found by handshake id in the key registry with the given data
      parameters:
        - in: path
          name: handshakeid
          description: id of the handshake that shall be updated
          required: true
          type: string
        - in: body
          name: handshake
          description: the necessary data to update a handshake
          required: true
          schema:
            $ref: '#/definitions/HandshakeObject'
      responses:
        200:
          description: Successful response; returns the handshakeObject updated with the new data
          schema:
            $ref: '#/definitions/HandshakeState'
        '400':
          description: Not successful response; fails if
          
          
            - handshakeid is missing
            
            - if no handshake can be found for the given handshakeid
            
            - if the triggered state transition isn't valid
            
            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'
    delete:
      tags:
        - handshake
        - 2BImplemented
      summary: deletes handshake
      description: deletes the handshake dataset identified by the handshake id
      parameters:
        - in: path
          name: handshakeid
          description: id of the handshake that shall be deleted
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the handshakeObject that has been deleted from the keyRegistry
          schema:
            $ref: '#/definitions/HandshakeState'
        '400':
          description: Not successful response; fails if
          
          
            - handshakeid is missing
            
            - if no handshake can be found for the given handshakeid
            
            - if the triggered state transition isn't valid
            
            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/ubirch/keyregistry/handshake/open/{pubkeyid}':
    get:
      tags:
        - handshake
        - 2BImplemented
      summary: returns open handshakes
      description: returns a full list of all handshakes in an open state for this pubKeyId as an array;  handshakeObjects are returned
      parameters:
        - in: path
          name: pubkeyid
          description: id of the pubKey that wants to lookup its open handshakes
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the requested handshakeObjects as an array
          schema:
            type: array
            items:
              $ref: '#/definitions/HandshakeObject'
        '400':
          description: Not successful response; fails if
          
          
            - pubkeyid is missing
            
            - if no pubKey can be found for the pubkeyid

            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/ubirch/keyregistry/handshake/state/{handshakeid}':
    get:
      tags:
        - handshake
        - 2BImplemented
      summary: returns handshake state
      description: returns the state of the handshake identified by the handshake id
      parameters:
        - in: path
          name: handshakeid
          description: id of the requested handshake
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the requested handshakeState
          schema:
            $ref: '#/definitions/HandshakeStateObject'
        '400':
          description: Not successful response; fails if
          
          
            - handshakeid is missing
            
            - if no handshake can be found for the given handshakeid

            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'
    put:
      tags:
        - handshake
        - 2BImplemented
      summary: updates handshake state
      description: updates the state of the handshake identified by the handshake id
      parameters:
        - in: path
          name: handshakeid
          description: id of the handshake that shall be updated
          required: true
          type: string
        - in: body
          name: handshakestate
          description: the necessary data to update the state of a handshake
          required: true
          schema:
            $ref: '#/definitions/HandshakeStateObject'
      responses:
        200:
          description: Successful response; returns the handshakeStateObject updated with the new state
          schema:
            $ref: '#/definitions/HandshakeStateObject'
        '400':
          description: Not successful response; fails if
          
          
            - handshakeid is missing
            
            - if no handshake can be found for the given handshakeid

            - if the triggered state transition isn't valid

            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'

  '/ubirch/keyregistry/handshake/state/open/{pubkeyid}':
    get:
      tags:
        - handshake
        - 2BImplemented
      summary: returns states of all open handshakes
      description: returns a full list of states for all handshakes in an open state for this pubKeyId as an array
      parameters:
        - in: path
          name: pubkeyid
          description: id of the pubKey that wants to lookup its open handshakes
          required: true
          type: string
      responses:
        200:
          description: Successful response; returns the requested handshakeStateObjects as an array
          schema:
            type: array
            items:
              $ref: '#/definitions/HandshakeStateObject'
        '400':
          description: Not successful response; fails if
          
          
            - pubkeyid is missing
            
            - if no pubKey can be found for the pubkeyid

            - the keyRegistry isn't reachable
          schema:
            $ref: '#/definitions/ErrorResponse'

            
definitions:
###########  device object  ###########
  DeviceStubObject:
    description: object for devices CRUD
    type: object
    required:
      - deviceId
    properties:
      deviceId:
        type: string
      deviceName:
        type: string
      deviceType:
        type: string
      deviceLastUpdated:
        type: string
        format: date-time
        description: timestamp when the device sent of requested data the last time
      syncState:
        type: integer
        description:
          0 = outofsync
          1 = insync
          100 = unknown
        enum:
          - 0
          - 1
          - 100
    example:
      {
        "deviceId": "06983253-9097-47a9-b041-b56b054e160a",
        "deviceType": "lightsSensor",
        "deviceName": "light_DE_Berlin_014",
        "deviceLastUpdated": "2016-06-29T21:50:13Z",
        "syncState": "0"
      }

  DeviceObject:
    description: object for devices CRUD
    allOf:
      - $ref: '#/definitions/DeviceStubObject'
      - type: object
        properties:
          created:
            type: string
            format: date-time
          updated:
            type: string
            format: date-time
          avatarLastUpdated:
            type: string
            format: date-time
            description: timestamp when the avatar (digital representation of this device) of this device was updated the last time
          hwDeviceId:
            type: string
          tags:
            type: array
            description: tags for filtering groups of devices
            items:
              type: string
          avatarState:
            type: object
            properties:
              desired:
                type: object
              reported:
                type: object
          deviceProperties:
            type: object
          subscriptions:
            type: array
            items:
              type: object
          deviceConfig:
            type: object

  DeviceState:
    description: object with a state of a device
    type: object
    properties:
      deviceId:
        type: string
        description: device id
      messageId:
        type: string
        description: id of the message containing this device state
      deviceType:
        type: string
        description: device type, e.g. lightsLamp, lightsSensor, temperatureSensor
      timestamp:
        type: string
        format: date-time
        description: timestamp when the device sent this state
      deviceTags:
        type: array
        description: list of user defined tags for this device 
        items:
          type: string
      deviceMessage:
        type: object
        description: device type dependent object containing the properties which describe the state of the device
          
  DeviceStateObject:
    description: envelope for a state of a device
    type: object
    properties:
      _id:
        type: string
        description: message id of this state message
      _index:
        type: string
        description: data source index (from elastic search)
      _score:
        type: integer
      _type:
        type: string
        description: message id
      _source:
        $ref: '#/definitions/DeviceState'

    
###########  wrapper for signed transfer  ###########
  SignedPackge:
    description: signature wrapper for any payload
    type: object
    discriminator: signedPackage
    properties:
      signature:
        type: string
        description: signature of this package signes the payload
      pubKey:
        type: string
        description: the pub key to check the signature
      version:
        type: string
        description: API version
      created:
        type: integer
        format: int64
        description: timestamp of creation date, will be generated on server at creation time

###########  key registry objects  ###########
  PubKey:
    description: public key object with the pubKey and it's unique pubKeyId
    type: object
    properties:
      pubKey:
        type: string
        description: the public key
      id:
        type: string
        description: the unique id used to find this public key in the key registry
      fingerprint:
        type: string
        description: fingerprint checksum for this public key

  Handshake:
    description: transfer of data and collected information for a handshake process
    type: object
    properties:
      id:
        type: string
        description: the unique id of this handshake in the key registry
      status:
        $ref: '#/definitions/HandshakeState'
      initiator:
        $ref: '#/definitions/HandshakeParty'
      responder:
        $ref: '#/definitions/HandshakeParty'
        
  HandshakeState:
    type: string
    description: indicates the state of this handshake process
    default: undefined
    enum:
      - undefined
      - init
      - validateInitiator
      - trustInitiator
      - initiatorValidationFailed
      - validateResponder
      - trustResponder
      - responderValidationFailed
      - successful
      - unsuccessful
      - finishedSuccessful
      - finishedUnsuccessful
      - timeout
      - aborted
      - deleted

  HandshakeParty:
    type: object
    description: public key and nonce to check key of this party
    required:
      - pubKeyRef
    properties:
      pubKeyRef:
        $ref: '#/definitions/PubKey'
      nonce:
        $ref: '#/definitions/Nonce'
    
  Nonce:
    type: object
    description: both parties of the handshake ask the other side to decrypt a random value (nonce), it encrypted with the public key of the other side, to check the correctness of this public key
    properties:
      value:
        type: string
        description: test phrase (nonce), encrypted with pubKey or decrypted as plaintext
      encrypted:
        type: boolean
        description: if true then the value of this nonce is encrypted, if false then it's decrypted and in plain text


###########  transfer packages  ###########
  PubKeyObject:
    description: public key object with the pubKey and it's unique pubKeyId
    allOf:
      - $ref: '#/definitions/SignedPackge'
      - type: object
        required:
          - payload
        properties:
          payload:
            type: object
            required:
             - pubKeyRef
            properties:
              pubKeyRef:
                $ref: '#/definitions/PubKey'

  HandshakeObject:
    type: object
    description: handshake object transfers content required to perform a handshake between two parties 
    allOf:
      - $ref: '#/definitions/SignedPackge'
      - type: object
        required:
          - payload
        properties:
          payload:
            type: object
            required:
             - handshake
            properties:
              handshake:
                $ref: '#/definitions/Handshake'

  HandshakeStateObject:
    type: object
    description: transfers the state of a handshake
    allOf:
      - $ref: '#/definitions/SignedPackge'
      - type: object
        required:
          - payload
        properties:
          payload:
            type: object
            required:
             - id
             - status
            properties:
              id:
                type: string
                description: the unique id of this handshake in the key registry
              status:
                $ref: '#/definitions/HandshakeState'

###########  block chain service  ###########
  BlockInfo:
    type: object
    description: short information abaut this chaining block
    properties:
      hash:
        type: string
        description: the hash value of the block, in which the event hash of the message has been mined
      previousBlockHash:
        type: string
        description: the hash value of the previous block of the block, in which the event hash of the message has been mined
      number:
        type: integer
        description: block number
      created:
        type: string
        format: time-date
        description: timestamp of the creation of this block
      version:
        type: string
        description: version of format
      anchors:
        type: array
        description: anchors which which this block and the previous blocks are anchored in bitcoin or etherium chain for notarization
        items:
          $ref: '#/definitions/NotaryAnchor'

  FullBlock:
    type: object
    description: full information abaut this chaining block containing the merkle tree
    allOf:
      - $ref: '#/definitions/BlockInfo'
      - type: object
        properties:
          hashes:
            type: array
            description: array of all hashes this block contains
            items:
              type: string

  NotaryAnchor:
    type: object
    description: bitcoin or etherium anchor to notarize this block and the predecessing blocks
    
    
###########  errors  ###########
  ErrorResponse:
    type: object
    description:
    
      error object with error code and message
      
    required:
      - apiVersion
      - status
      - error
    properties:
      apiVersion:
        type: string
      status:
        type: string
        description: KO because it's an error
      error:
        type: object
        required:
          - errorId
          - errorMessage
        properties:
          errorId:
            type: string
            enum:
              - "ErrorTimeOut"
              - "ErrorNotHandled"
              - "ErrorFatalIntern"
              - "ErrorMissingParams"
              - "ErrorPubKeyIdExists"
              - "ErrorInvalidPubKeyId"
              - "ErrorUpdatePubKey"
              - "ErrorParseJson"
              - "ErrorCannotDeletePubKey"
              - "ErrorHandshakeCannotFindDestination"
              - "ErrorHandshakeFailedTimeout"
              - "ErrorHandshakeFailedWrongResult"
              - "ErrorInvalidSignature"
              - "ErrorInvalidHandshakeId"
              - "ErrorHandshakeInterrupted"
              - "ErrorNoHandshakeState"
             
          errorMessage:
            type: string
            enum:
              - "request could not be processed in time"
              - "request could not be handled"
              - "fatal internal error"
              - "missing parameters"
              - "given pubKeyId for new public key already exists"
              - "cannot find public key for given pubKeyId"
              - "public key for given pubKeyId cannot be updated"
              - "cannot parse incoming json doc"
              - "cannot delete PubKey from datatbase"
              - "cannot find destination given by pubKeyId"
              - "handshake failed because the destination didn't responde in time"
              - "Decrypted result value of handshake process isn't equal with encrypted random value"
              - "Verification of signature failed"
              - "Cannot find handshake data of given handshakeId"
              - "Handshake process has been interrupted by the other part"
              - "Cannot read handshake state of given handshakeId"